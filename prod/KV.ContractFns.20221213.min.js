KV.ContractFns={cts:{},ct_abisource_base:{1:"https://api.etherscan.io/api?module=contract&action=getabi&address=",3:null,5:null,42:null,56:"https://api.bscscan.com/api?module=contract&action=getabi&address=",97:"https://api-testnet.bscscan.com/api?module=contract&action=getabi&address=",137:"https://api.polygonscan.com/api?module=contract&action=getabi&address=",80001:null},ct_abisource_apikeys:{},_readycts:{},_queuects:{}};
KV.ContractFns.get_abi_url=function(a){a=KV.wallet.web3().eth.getChainId();var b=KV.ContractFns.ct_abisource_base[a];return b?b+=KV.ContractFns.ct_abisource_apikeys[a]?"&apikey="+KV.ContractFns.ct_abisource_apikeys[a]:"":!1};KV.ContractFns.set_abi_apikey=function(a,b){return"number"==typeof a&&"string"==typeof b?(KV.ContractFns.ct_abisource_apikeys[a]=b,!0):!1};
KV.ContractFns.prepare_contract=function(a){return new Promise(function(b,k){KV.ContractFns.cts[a.short_name]=new KV.Contract(a.contract_address);KV.ContractFns.cts[a.short_name].load("string"==typeof a.contract_abi?a.contract_abi:KV.ContractFns.get_abi_url(a.contract_address),a.readonly_from_chain_id).then(function(e){KV.ContractFns._ct_prepared(a.short_name);b(e)})["catch"](function(e){k(e)})})};
KV.ContractFns._ct_prepared=function(a){KV.ContractFns._readycts[a]=!0;if(Array.isArray(KV.ContractFns._queuects[a])&&0<KV.ContractFns._queuects[a].length)for(;0<KV.ContractFns._queuects[a].length;)KV.ContractFns._queuects[a].pop()(KV.ContractFns.cts[a])};KV.ContractFns.when_ready=function(a){return new Promise(function(b,k){KV.ContractFns._readycts[a]?b(KV.ContractFns.cts[a]):(Array.isArray(KV.ContractFns._queuects[a])||(KV.ContractFns._queuects[a]=[]),KV.ContractFns._queuects[a].push(b))})};
KV.ContractFns.get_token_balances=function(a,b,k,e){return new Promise(function(n,p){var f=JSON.parse(localStorage.getItem("w3cache")),d={};if(!k&&f&&f.tokenBalances)for(tName in b){if(b.hasOwnProperty(tName)){if("undefined"==typeof f.tokenBalances[tName]||f.tokenBalances[tName].lastCheck+CACHE_THRESHOLD<(new Date).getTime())d[tName]=b[tName];"undefined"==typeof KV.ContractFns.cts[tName]&&(KV.ContractFns.cts[tName]=new KV.Contract(d[tName].contract),KV.ContractFns.cts[tName].load(KV.ContractFns.get_abi_url(d[tName].contract)))}}else d=
b;d=[];for(var g={},l=0,m=0;m<ccys.length;m++)d.push(KV.ContractFns.cts[tokenName].w3contract.methods.balanceOf(wallet).call()),d.push(KV.ContractFns.cts[tokenName].w3contract.methods.decimals().call()),g[l++]={currency:tokenName,type:"balanceOf"},g[l++]={currency:tokenName,type:"decimals"},"object"==typeof e&&"string"==typeof e[tokenName]?(d.push(KV.ContractFns.cts[tokenName].w3contract.methods.allowance(wallet,e[tokenName]).call()),g[l++]={currency:tokenName,type:"allowance"}):"string"==typeof e&&
(d.push(KV.ContractFns.cts[tokenName].w3contract.methods.allowance(wallet,e).call()),g[l++]={currency:tokenName,type:"allowance"});Promise.all(d).then(function(h){for(var c=0;c<h.length;c++)if(h)switch(g[c].type){case "balanceOf":f[g[c].currency].balance=h[c];break;case "decimals":f[g[c].currency].decimals=h[c];break;case "allowance":f[g[c].currency].allowance=h[c];break;default:console.error("Unknown response index ["+c+"]",h[c])}localStorage.setItem("w3cache",JSON.stringify(f));n(f)})["catch"](function(h){p(h)})})};
